---
title: "dataDocumentation"
author: "Catherine dell'Olio"
date: "2025-10-20"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Rmisc)
library(ggplot2)
library(vegan)
library(dplyr)
```

```{r dataSplitter, include=FALSE}
setwd("~/dataAnalysisCfd")
source("dataSplitter.R")
```

```{r ordBuilder, echo=FALSE}
trtSetup <- function(ordTrtData, trt_var, trt_0, trt_1){
  colnames(ordTrtData)[colnames(ordTrtData) == 'response'] <- 'numID'
  for (i in 1:nrow(ordTrtData)) {
    ordTrtData$numID[i] <- i
  }
  colnames(ordTrtData)[colnames(ordTrtData) == trt_var] <- 'trt'
  for (i in 1:nrow(ordTrtData)) {
    if (ordTrtData$trt[i] == trt_0) ordTrtData$trt[i] <- 0
    if (ordTrtData$trt[i] == trt_1) ordTrtData$trt[i] <- 1
  }
  return(ordTrtData)
}

trtSetupNumerical <- function(ordTrtData, trt_var, trt_cutoff_incl){
  colnames(ordTrtData)[colnames(ordTrtData) == 'response'] <- 'numID'
  for (i in 1:nrow(ordTrtData)) {
    ordTrtData$numID[i] <- i
  }
  colnames(ordTrtData)[colnames(ordTrtData) == trt_var] <- 'trt'
  for (i in 1:nrow(ordTrtData)) {
    if (ordTrtData$trt[i] <= trt_cutoff_incl) ordTrtData$trt[i] <- 0
    if (ordTrtData$trt[i] > trt_cutoff_incl) ordTrtData$trt[i] <- 1
  }
  return(ordTrtData)
}
  
stressTest <- function(orddata){
  dim1<-metaMDS(orddata, k = 1, trymax = 100)
  s1<-dim1[[22]]
  dim2<-metaMDS(orddata,k=2,trymax = 100)
  s2<-dim2[[22]]
  dim3<-metaMDS(orddata,k=3,trymax = 100)
  s3<-dim3[[22]]
  return(c(s1,s2,s3))
}

ord_er <- function(orddata){
  ord<-metaMDS(orddata,k=2)
  return(ord)
}
 
  #NMDS plot colors
colvec <- c("green4", "blue4")
pchvec <- c(0, 1)

plainNMDS <- function(orddata, title, stress) {
  plot(ord$points, type = "n", main = title, sub = paste0("stress = ", round(stress[2], 3)))
  with(orddata, points(ord, display = "sites", col = colvec, pch = pchvec, cex=1.5)) 
  legend("topleft",legend = c(trt_0, trt_1), col = colvec, pch = pchvec, bty = "n", pt.cex = 1.5, cex = 1, text.col = "black", horiz = F, inset = c(0.01))
}

plot_ano <- function(){
  ano <-  anosim(orddata, trt$trt, distance = "bray", permutations = 9999)
  plot(ano)
}

NMDS_centroids <- function(ord){
  data.scores <- as.data.frame(scores(ord)$sites)
  data.scores$trt <- trt$trt
  
  ## this next section is how to make connected centroids
  cent <- aggregate(cbind(NMDS1, NMDS2) ~ trt, data = data.scores, FUN = mean)
  
  segs <- merge(data.scores, setNames(cent, c('trt','oNMDS1','oNMDS2')),
                by = 'trt', sort = FALSE)
  
  all.trt.nmds <- ggplot(data.scores, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 3, aes( shape = factor(trt), colour = factor(trt))) + 
    geom_segment(data = segs,
                 mapping = aes(xend = oNMDS1, yend = oNMDS2)) + 
    geom_point(data = cent, size = 5, colour=colvec, shape=pchvec) +
    scale_shape_manual(values=c(0,1,2))+ #can add Xlim and Ylim here if needed
    theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"),
          axis.text.x = element_text(colour = "black", face = "bold", size = 12), 
          legend.text = element_text(size = 12, face ="bold", colour ="black"), 
          legend.position = "none", 
          axis.title.x = element_text(face = "bold", size = 14, colour = "black"),
          axis.title.y = element_text(face = "bold", size = 14, colour = "black"),
          panel.background = element_blank(), 
          panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2))+
    labs(x = "NMDS1", y = "NMDS2")  + 
    scale_colour_manual(values = colvec)
  all.trt.nmds
}

NMDS_ellipses <- function(ord){
  plot(ord$points, col = colvec, pch = pchvec)
  # draw dispersion ellipses around data points
  ordiellipse(ord, trt$trt, display = "sites", kind = "sd", label = T)
}

```

```{r settingOrd, echo=TRUE, warning=FALSE, results='hide', message=FALSE, fig.keep='all', fig.show="hold", out.width="50%"}
#associate trees NMDS builder
#note: columns 76 through 103 are the trees presence/absence data
#MAKE CHANGES HERE
ordTrtData <- data_CPVTliveadults
trt_var <- "retention_strategy"
trt_0 <- "healthy"
trt_1 <- "unhealthy"
title <- "NMDS of retention strategies healthy (0) vs unhealthy (1)"
#END OF CHANGES

ordTrtData <- trtSetup(ordTrtData, trt_var, trt_0, trt_1)
trt <- ordTrtData %>% select("numID", "trt")
orddata <- ordTrtData[c(1, 76:103)]
stress <- stressTest(orddata)
ord <- invisible(ord_er(orddata))
plot_ano
plainNMDS(ord, title, stress)
NMDS_centroids(ord)
NMDS_ellipses(ord)

#CHANGES HERE
ordTrtData <- data_liveseedlings
trt_var <- "seedling_previous_stem_count"
trt_cutoff_incl <- 2
trt_0 <- "2 or less"
trt_1 <- "more than 2"
title <- "communities by seedlings that have more than 2 or at most 2 stems"
#remember this is numerical categorization not discrete so we will use trtSetupNumerical

ordTrtData <- trtSetupNumerical(ordTrtData, trt_var, trt_cutoff_incl)
trt <- ordTrtData %>% select("numID", "trt")
orddata <- ordTrtData[c(1, 76:103)]
ord <- invisible(ord_er(orddata))
stress <- stressTest(orddata)
plot_ano
plainNMDS(ord, title, stress)
NMDS_centroids(ord)
NMDS_ellipses(ord)

#MAKE CHANGES HERE
ordTrtData <- data
trt_var <- "site"
trt_0 <- "ILM"
trt_1 <- "CPVT"
title <- "Communities across sites: ILM (0) vs CPVT (1)"
#END OF CHANGES

ordTrtData <- trtSetup(ordTrtData, trt_var, trt_0, trt_1)
trt <- ordTrtData %>% select("numID", "trt")
orddata <- ordTrtData[c(1, 76:103)]
stress <- stressTest(orddata)
ord <- invisible(ord_er(orddata))
plot_ano
plainNMDS(ord, title, stress)
NMDS_centroids(ord)
NMDS_ellipses(ord)
```

```{r seedlingsVsAdultsNMDS, echo=TRUE, warning=FALSE, results='hide', message=FALSE, fig.keep='all', fig.show="hold", out.width="50%"}

#CHANGES HERE
ordTrtData <- data_CPVT
trt_var <- "seedling_or_adult"
trt_0 <- "Seedling"
trt_1 <- "Adult"
#END OF CHANGES

ordTrtData <- trtSetup(ordTrtData, trt_var, trt_0, trt_1)
trt <- ordTrtData %>% select("numID", "trt")
orddata <- ordTrtData[c(1, 76:103)]
ord <- invisible(ord_er(orddata))
ano <-  anosim(orddata, trt$trt, distance = "bray", permutations = 9999)
plot(ano)
plainNMDS(ord)
NMDS_centroids(ord)
NMDS_ellipses(ord)

#CHANGES HERE
ordTrtData <- data_ILM
trt_var <- "seedling_or_adult"
trt_0 <- "Seedling"
trt_1 <- "Adult"
#END OF CHANGES

ordTrtData <- trtSetup(ordTrtData, trt_var, trt_0, trt_1)
trt <- ordTrtData %>% select("numID", "trt")
orddata <- ordTrtData[c(1, 76:103)]
ord <- invisible(ord_er(orddata))
plot_ano
plainNMDS(ord)
NMDS_centroids(ord)
NMDS_ellipses(ord)
```

```{r riparianVsUpland, echo=TRUE, warning=FALSE, results='hide', message=FALSE, fig.keep='all', fig.show="hold", out.width="50%"}
#CHANGES HERE
ordTrtData <- data
trt_var <- "riparian_or_upland"
trt_0 <- "Riparian"
trt_1 <- "Upland"
#END OF CHANGES

ordTrtData <- trtSetup(ordTrtData, trt_var, trt_0, trt_1)
trt <- ordTrtData %>% select("numID", "trt")
orddata <- ordTrtData[c(1, 76:103)]
ord <- invisible(ord_er(orddata))
plot_ano
plainNMDS(ord)
NMDS_centroids(ord)
NMDS_ellipses(ord)
```
